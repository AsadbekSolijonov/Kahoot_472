<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Waiting Room</title>
</head>
<body>
    <h1>Waiting Room</h1>
    <h2>Game PIN: {{ game.pin_code }}</h2>

    <!-- Form to join the game -->
    <form id="joinForm">
        <input type="text" id="nickname" name="nickname" placeholder="Enter your nickname" required>
        <button type="submit">Join Game</button>
    </form>

    <!-- Players joined with Remove button -->
    <h3>Players Joined:</h3>
    <ul id="playersList">
        {% for player in players %}
            <li id="player-{{ player.id }}">
                {{ player.nickname }}
                <button class="removePlayer" data-player-id="{{ player.id }}">Remove</button>
            </li>
        {% empty %}
            <li>No players yet</li>
        {% endfor %}
    </ul>

    <button id="startGame">Start Game</button>

    <script>
        const pinCode = "{{ game.pin_code }}";
        const playersList = document.getElementById('playersList');

        // WebSocket connection for the game
        const gameSocket = new WebSocket(
            'ws://' + window.location.host + '/ws/game/' + pinCode + '/'
        );

        // Handle WebSocket messages
        gameSocket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            const action = data.action;

            if (action === 'join') {
                const nickname = data.nickname;
                const newPlayer = document.createElement('li');
                newPlayer.id = 'player-' + data.player_id;
                newPlayer.innerHTML = `${nickname} <button class="removePlayer" data-player-id="${data.player_id}">Remove</button>`;
                playersList.appendChild(newPlayer);
            } else if (action === 'remove') {
                const playerId = data.player_id;
                const playerElement = document.getElementById('player-' + playerId);
                if (playerElement) {
                    playerElement.remove();
                }
            } else if (action === 'start_game') {
                window.location.href = '/game/' + pinCode + '/started/';
            }
        };

        // Join game via WebSocket
        document.getElementById('joinForm').onsubmit = function(e) {
            e.preventDefault();
            const nickname = document.getElementById('nickname').value;

            gameSocket.send(JSON.stringify({
                'action': 'join',
                'nickname': nickname,
            }));
        };

        // Remove player via WebSocket
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('removePlayer')) {
                const playerId = e.target.getAttribute('data-player-id');
                gameSocket.send(JSON.stringify({
                    'action': 'remove',
                    'player_id': playerId,
                }));
            }
        });

        // Start game via WebSocket
        document.getElementById('startGame').onclick = function() {
            gameSocket.send(JSON.stringify({
                'action': 'start_game'
            }));
        };
    </script>
</body>
</html>
